# Lab 2
## Interrupts

### Table of Contents
<br>

| Step | Description | Points |
|------|-------------|--------|
| 0.1 | Set up your environment |   |
| 0.2 | Read about interrupts |   |
| 1 | Read the datasheet | 20 |
| 2 | External Interrupts | 20 |
| 3 | Platform Timer Interrupts | 20 |
| 4 | Doorbell Interrupts | 20 |
| 5 | In-Lab Checkoff Step | 20* |
| &nbsp; | Total: | 100 |
<br>

\* - You must get your whole lab checked off before the end of your lab section to avoid a late penalty of 20%.

### Introduction

A key concept in embedded systems is the need to process external stimuli, like a button press, or when a sensor detects a change in its environment.  However, the microcontroller may already be busy executing another long running task - maybe it's waiting on a second sensor, or its busy updating a large display.  This is actually a very common scenario you'll encounter when you start thinking about your course project - how do you get your microcontroller to do a lot of different things at the same time?  In this lab, we'll explore how to use **interrupts** to handle these situations.

An interrupt, or event, or trap, is a signal that is generated by the hardware or software when an event occurs that needs immediate attention.  Once it's **fired** from an interrupt source, the interrupt signal arrives at the CPU, which saves what it's doing, and then - if the conditions are right and the correct bits are set - the CPU will execute a special function called an **interrupt service routine** (ISR), which you will implement.

There's three types of interrupts we can explore that's common to most microcontrollers:
1. **External Interrupts**: These are triggered by external hardware.  There are four kinds of interrupts - two level-triggered (logic 1 or logic 0), and two-edge triggered (rising or falling edge).  
    - The difference between the two types is that level-triggered interrupts will keep firing as long as the condition is met, while edge-triggered interrupts will only fire once per "trigger".  For our purposes, edge-triggered interrupts are more useful.
2. **Peripheral Interrupts**: These are triggered by special events that occur on peripherals, such as timers, which can be configured to generate an interrupt when their internal counter reaches a certain value, among other possible events.

But with the Pico 2, we have a very interesting third type of interrupt: doorbell interrupts!  If you hadn't noticed, your Pico 2 has two pairs of ARM and RISC-V cores that you can use, and this lab gives you an opportunity to explore how to use them.  Doorbell interrupts are a way for one core to signal the other core that it has something important to do, and the other core will stop what it's doing and execute the corresponding ISR.  This is a very powerful feature that you can use to offload tasks from one core to another, or to signal that a task is complete.

## Instructional Objectives
- To understand the concept of interrupts.
- To learn how to configure an external interrupt on the Pico 2.
- To learn how to configure a platform timer interrupt on the Pico 2.
- To learn how to configure a doorbell interrupt on the Pico 2.

> [!IMPORTANT]
> Similar to 270, 362 labs should be started at home, and checked off in lab.  **Do not wait to start your lab in your lab section, or you will not finish.**  You must be **checked off for all steps in lab** to receive full credit.

### Step 0.1: Set up your environment

Make sure to clone the code repository from GitHub Classroom.  Keep in mind to add, commit and push any changes you make so that your work is accessible from a lab machine. 

Open the template in VScode and with your Debug Probe connected to your Pico 2, click "Flash Project (SWD)".  Open the Serial Monitor to see the output of your program, and press the Reset button so that it prints out again.  You should now see the following:

```text
Interrupts Lab Test Suite for Pico 2
Type 'help' to learn commands.

> 
```

You can then type `help` to learn what commands you can use to test a certain subroutine.  You will use this to demo your implementation and wiring to the TAs.

### Step 0.2: Read about interrupts

In this lab, it's helpful to have an understanding of the layout of the processor cores on your microcontroller.  The Pico 2 has four cores, of which only two are usable at one time, as shown in this diagram ([Figure 6, Chapter 3, RP2350 Datasheet](https://datasheets.raspberrypi.com/rp2350/rp2350-datasheet.pdf#%5B%7B%22num%22%3A37%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C841.89%2Cnull%5D)):

![Pico 2 Core Layout](core-diagram.png)

You can see the four CPU cores in the middle block, but note how they go through muxes (which only allows a connection to be made to one of the two cores in each pair), and then to the "Split" below the block.  This is where the cores are given access to the ["bus fabric"](https://datasheets.raspberrypi.com/rp2350/rp2350-datasheet.pdf#%5B%7B%22num%22%3A26%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C709.282%2Cnull%5D) which is a term that refers to the main system bus that connects all the peripherals and memory to the CPU cores.  On every clock cycle, depending on the instructions they execute, the cores read or write to the bus fabric, which then carries those transmissions from or to the peripherals and memory.

The top block is the debugging interface, that allows a debug host (which is your Debug Probe connected to the SWCLK and SWD pins of your Pico 2) to control the core behavior.  Chapter 3 tells us that the debugger allows you to:

- Run, halt and reset the (CPU) cores
- Inspect internal core state such as registers
- Access memory from the coreâ€™s point of view
- Load code onto the device and run it

As for interrupts, we see a bus called "System Interrupts" that connects to all the cores through the IRQ (Interrupt ReQuests).  This is how interrupts reach the CPU cores, causing main program execution to halt and the ISR to run.  

So what interrupts are available?  Scroll down to section 3.2, and you'll see:

- "Cross-core FIFO interrupts: SIO_IRQ_FIFO and SIO_IRQ_FIFO_NS (Section 3.1.5)"
    - Also called "mailboxes", these are used to send ordered messages between cores.
    - We won't worry about these for now.
- "Cross-core doorbell interrupts: SIO_IRQ_BELL and SIO_IRQ_BELL_NS (Section 3.1.6)"
    - These are used to signal the other core that it has something to do, but doesn't necessarily have to be ordered or contain other data like the mailbox interrupt.
- "RISC-V platform timer (also usable by Arm cores): SIO_IRQ_MTIMECMP (Section 3.1.8)"
    - This is a timer that can be used to generate interrupts at a certain time, or at a certain interval, relative to the number of "ticks" that have passed since the timer was started.  (Ticks are not necessarily synchronized to a unit of time, although you can make it that way if you want.)
    - It's called "RISC-V Platform" because the timer is described as part of the RISC-V instruction set that dictates how the RISC-V cores should process instructions, although the ARM cores can also use it if they wish.
- "GPIO interrupts: IO_IRQ_BANK0, IRQ_IO_BANK0_NS, IO_IRQ_QSPI, IO_IRQ_QSPI_NS (Section 9.5)"
    - When an external interrupt occurs, the GPIO pins can be configured to generate an interrupt signal that can be sent to the CPU cores.

### Step 1: Read the datasheet

Make sure you did the reading in Step 0.2, and then read the following sections of the RP2350 datasheet and answer the questions underneath.

[Chapter 3.1.6: Doorbells](https://datasheets.raspberrypi.com/rp2350/rp2350-datasheet.pdf#%5B%7B%22num%22%3A44%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C147.15%2Cnull%5D)

1. What is the name of the interrupt and the corresponding number that you need to enable to use doorbell interrupts?
2. What register do you need to write to to trigger an interrupt on the opposite core?
3. Can a core 

[Chapter 3.1.8: RISC-V Platform Timer](https://datasheets.raspberrypi.com/rp2350/rp2350-datasheet.pdf#%5B%7B%22num%22%3A45%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C420.246%2Cnull%5D)

[Chapter 9.5: GPIO Interrupts](https://datasheets.raspberrypi.com/rp2350/rp2350-datasheet.pdf#%5B%7B%22num%22%3A592%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C564.608%2Cnull%5D)

In [Chapter 3.2: Interrupts](https://datasheets.raspberrypi.com/rp2350/rp2350-datasheet.pdf#%5B%7B%22num%22%3A84%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C115%2C361.924%2Cnull%5D), identify the IRQ numbers that correspond to the source that would trigger when pushbuttons on GP20 or GP21 are pressed (from the last lab).